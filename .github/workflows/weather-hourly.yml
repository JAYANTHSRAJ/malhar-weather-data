name: Hourly Weather Snapshot (Clean)

on:
  schedule:
    - cron: "0 * * * *"   # runs hourly (UTC)
  workflow_dispatch:

jobs:
  collect-weather:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Fetch, normalize & store weather (IST hour bucket)
        run: |
          set -e

          RAW=$(curl -s "https://api.ambientweather.net/v1/devices?apiKey=${{ secrets.API_KEY }}&applicationKey=${{ secrets.APP_KEY }}")

          # Sensor timestamp (UTC)
          SENSOR_DATE=$(echo "$RAW" | jq -r '.[0].lastData.date')

          # Convert to IST
          IST_DATE=$(date -d "$SENSOR_DATE +5 hours 30 minutes" +"%Y-%m-%d")
          IST_HOUR=$(date -d "$SENSOR_DATE +5 hours 30 minutes" +"%H")

          DIR="data/device/hourly/$IST_DATE"
          FILE="$DIR/$IST_HOUR-00.json"

          mkdir -p "$DIR"

          # Build CLEAN Quick View snapshot
          echo "$RAW" | jq '.[0].lastData | {
            timestamp: .date,

            outdoor: {
              temperature: ((.tempf - 32) * 5 / 9),
              feelsLike: ((.feelsLike - 32) * 5 / 9),
              dewPoint: ((.dewPoint - 32) * 5 / 9)
            },

            wind: {
              speed: (.windspeedmph * 1.60934),
              gust: (.windgustmph * 1.60934),
              maxDailyGust: (.maxdailygust * 1.60934),
              direction: .winddir
            },

            rain: {
              rate: (.hourlyrainin * 25.4),
              daily: (.dailyrainin * 25.4),
              weekly: (.weeklyrainin * 25.4)
            },

            pressure: {
              relative: .baromrelin,
              absolute: .baromabsin
            },

            humidity: {
              outdoor: .humidity,
              indoor: .humidityin
            },

            indoor: {
              temperature: ((.tempinf - 32) * 5 / 9),
              feelsLike: ((.feelsLikein - 32) * 5 / 9),
              dewPoint: ((.dewPointin - 32) * 5 / 9)
            },

            solar: {
              uv: .uv,
              radiation: .solarradiation
            }
          }' > "$FILE"

      - name: Commit and push
        run: |
          git config user.name "weather-bot"
          git config user.email "weather-bot@users.noreply.github.com"
          git add data/device/hourly
          git commit -m "Hourly clean snapshot (IST) $(date -u)" || echo "No changes"
          git push
