name: Hourly Weather Snapshot (Guaranteed 24)

on:
  schedule:
    - cron: "0 * * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  collect-weather:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Fetch & store hourly snapshot (IST bucket)
        run: |
          set -e

          NOW_IST=$(TZ=Asia/Kolkata date +"%Y-%m-%d %H:00")
          IST_DATE=$(TZ=Asia/Kolkata date +"%Y-%m-%d")
          IST_HOUR=$(TZ=Asia/Kolkata date +"%H")

          DIR="data/device/hourly/$IST_DATE"
          FILE="$DIR/$IST_HOUR-00.json"

          mkdir -p "$DIR"

          RAW=$(curl -sf "https://api.ambientweather.net/v1/devices?apiKey=${{ secrets.API_KEY }}&applicationKey=${{ secrets.APP_KEY }}")

          SENSOR_DATE=$(echo "$RAW" | jq -r '.[0].lastData.date // empty')

          echo "$RAW" | jq --arg bucket "$NOW_IST" --arg sensor "$SENSOR_DATE" '
            .[0].lastData as $d |
            {
              bucketHour: $bucket,
              sensorTimestamp: $sensor,
              stale: ($sensor == null),

              outdoor: {
                temperature: (($d.tempf - 32) * 5 / 9),
                feelsLike: (($d.feelsLike - 32) * 5 / 9),
                dewPoint: (($d.dewPoint - 32) * 5 / 9)
              },

              wind: {
                speed: ($d.windspeedmph * 1.60934),
                gust: ($d.windgustmph * 1.60934),
                maxDailyGust: ($d.maxdailygust * 1.60934),
                direction: $d.winddir
              },

              rain: {
                rate: ($d.hourlyrainin * 25.4),
                daily: ($d.dailyrainin * 25.4),
                weekly: ($d.weeklyrainin * 25.4)
              },

              pressure: {
                relative: $d.baromrelin,
                absolute: $d.baromabsin
              },

              humidity: {
                outdoor: $d.humidity,
                indoor: $d.humidityin
              },

              indoor: {
                temperature: (($d.tempinf - 32) * 5 / 9),
                feelsLike: (($d.feelsLikein - 32) * 5 / 9),
                dewPoint: (($d.dewPointin - 32) * 5 / 9)
              },

              solar: {
                uv: $d.uv,
                radiation: $d.solarradiation
              }
            }
          ' > "$FILE"

      - name: Commit and push
        run: |
          git config user.name "weather-bot"
          git config user.email "weather-bot@users.noreply.github.com"
          git add data/device/hourly
          git commit -m "Hourly snapshot $(TZ=Asia/Kolkata date '+%Y-%m-%d %H:00 IST')" || echo "No changes"
          git push
